# Twitter
Twitterに関するもの

importzzzsysabcdeimportzzzcv2abcdeimportzzznumpyzzzaszzznpabcdeimportzzztensorflowzzzaszzztfabcdeimportzzztensorflow.python.platformabcdeimportzzzosabcdeimportzzzglobabcdeimportzzzscipyabcdefromzzzscipyzzzimportzzzioabcdeimportzzztimeabcdefromzzztensorflow.contribzzzimportzzzlearnabcdeimportzzzrandomabcdefromzzzjoblibzzzimportzzzParallel,zzzdelayedabcdeabcde###############################################################################abcde#zzzConstantszzzforzzzthezzzimagezzzinputzzzandzzzoutput.abcde###############################################################################abcdeabcde#zzzOutputzzzfolderzzzforzzzthezzzimages.abcdeOUTPUT_DIRzzz=zzz'output/'abcde#zzzStylezzzimagezzztozzzuse.abcdeSTYLE_IMAGEzzz=zzz'images/guernica.jpg'abcde#zzzContentzzzimagezzztozzzuse.abcdeCONTENT_IMAGEzzz=zzz'images/hongkong.jpg'abcde#zzzImagezzzdimensionszzzconstants.zzzabcdeIMAGE_WIDTHzzz=zzz288abcdeIMAGE_HEIGHTzzz=zzz288abcdeCOLOR_CHANNELSzzz=zzz3abcdeabcde###############################################################################abcde#zzzAlgorithmzzzconstantsabcde###############################################################################abcde#zzzNoisezzzratio.zzzPercentagezzzofzzzweightzzzofzzzthezzznoisezzzforzzzintermixingzzzwithzzztheabcde#zzzcontentzzzimage.abcdeNOISE_RATIOzzz=zzz0.6abcdeabcdeVGG_MODELzzz=zzz'imagenet-vgg-verydeep-19.mat'abcde#zzzThezzzmeanzzztozzzsubtractzzzfromzzzthezzzinputzzztozzzthezzzVGGzzzmodel.zzzThiszzziszzzthezzzmeanzzzthatabcde#zzzwhenzzzthezzzVGGzzzwaszzzusedzzztozzztrain.zzzMinorzzzchangeszzztozzzthiszzzwillzzzmakezzzazzzlotzzzofabcde#zzzdifferencezzztozzzthezzzperformancezzzofzzzmodel.abcdeMEAN_VALUESzzz=zzznp.array([123.68,zzz116.779,zzz103.939]).reshape((1,1,1,3))abcdeabcdedefzzzload_vgg_model(path):abcdezzzzzzzzzzzz"""abcdezzzzzzzzzzzzReturnszzzazzzmodelzzzforzzzthezzzpurposezzzofzzz'painting'zzzthezzzpicture.abcdezzzzzzzzzzzzTakeszzzonlyzzzthezzzconvolutionzzzlayerzzzweightszzzandzzzwrapzzzusingzzzthezzzTensorFlowabcdezzzzzzzzzzzzConv2d,zzzReluzzzandzzzAveragePoolingzzzlayer.zzzVGGzzzactuallyzzzuseszzzmaxpoolzzzbutabcdezzzzzzzzzzzzthezzzpaperzzzindicateszzzthatzzzusingzzzAveragePoolingzzzyieldszzzbetterzzzresults.abcdezzzzzzzzzzzzThezzzlastzzzfewzzzfullyzzzconnectedzzzlayerszzzarezzznotzzzused.abcdezzzzzzzzzzzzHerezzziszzzthezzzdetailedzzzconfigurationzzzofzzzthezzzVGGzzzmodel:abcdezzzzzzzzzzzzzzzzzzzzzzzz0zzziszzzconv1_1zzz(3,zzz3,zzz3,zzz64)abcdezzzzzzzzzzzzzzzzzzzzzzzz1zzziszzzreluabcdezzzzzzzzzzzzzzzzzzzzzzzz2zzziszzzconv1_2zzz(3,zzz3,zzz64,zzz64)abcdezzzzzzzzzzzzzzzzzzzzzzzz3zzziszzzreluzzzzzzzzzzzzabcdezzzzzzzzzzzzzzzzzzzzzzzz4zzziszzzmaxpoolabcdezzzzzzzzzzzzzzzzzzzzzzzz5zzziszzzconv2_1zzz(3,zzz3,zzz64,zzz128)abcdezzzzzzzzzzzzzzzzzzzzzzzz6zzziszzzreluabcdezzzzzzzzzzzzzzzzzzzzzzzz7zzziszzzconv2_2zzz(3,zzz3,zzz128,zzz128)abcdezzzzzzzzzzzzzzzzzzzzzzzz8zzziszzzreluabcdezzzzzzzzzzzzzzzzzzzzzzzz9zzziszzzmaxpoolabcdezzzzzzzzzzzzzzzzzzzzzzzz10zzziszzzconv3_1zzz(3,zzz3,zzz128,zzz256)abcdezzzzzzzzzzzzzzzzzzzzzzzz11zzziszzzreluabcdezzzzzzzzzzzzzzzzzzzzzzzz12zzziszzzconv3_2zzz(3,zzz3,zzz256,zzz256)abcdezzzzzzzzzzzzzzzzzzzzzzzz13zzziszzzreluabcdezzzzzzzzzzzzzzzzzzzzzzzz14zzziszzzconv3_3zzz(3,zzz3,zzz256,zzz256)abcdezzzzzzzzzzzzzzzzzzzzzzzz15zzziszzzreluabcdezzzzzzzzzzzzzzzzzzzzzzzz16zzziszzzconv3_4zzz(3,zzz3,zzz256,zzz256)abcdezzzzzzzzzzzzzzzzzzzzzzzz17zzziszzzreluabcdezzzzzzzzzzzzzzzzzzzzzzzz18zzziszzzmaxpoolabcdezzzzzzzzzzzzzzzzzzzzzzzz19zzziszzzconv4_1zzz(3,zzz3,zzz256,zzz512)abcdezzzzzzzzzzzzzzzzzzzzzzzz20zzziszzzreluabcdezzzzzzzzzzzzzzzzzzzzzzzz21zzziszzzconv4_2zzz(3,zzz3,zzz512,zzz512)abcdezzzzzzzzzzzzzzzzzzzzzzzz22zzziszzzreluabcdezzzzzzzzzzzzzzzzzzzzzzzz23zzziszzzconv4_3zzz(3,zzz3,zzz512,zzz512)abcdezzzzzzzzzzzzzzzzzzzzzzzz24zzziszzzreluabcdezzzzzzzzzzzzzzzzzzzzzzzz25zzziszzzconv4_4zzz(3,zzz3,zzz512,zzz512)abcdezzzzzzzzzzzzzzzzzzzzzzzz26zzziszzzreluabcdezzzzzzzzzzzzzzzzzzzzzzzz27zzziszzzmaxpoolabcdezzzzzzzzzzzzzzzzzzzzzzzz28zzziszzzconv5_1zzz(3,zzz3,zzz512,zzz512)abcdezzzzzzzzzzzzzzzzzzzzzzzz29zzziszzzreluabcdezzzzzzzzzzzzzzzzzzzzzzzz30zzziszzzconv5_2zzz(3,zzz3,zzz512,zzz512)abcdezzzzzzzzzzzzzzzzzzzzzzzz31zzziszzzreluabcdezzzzzzzzzzzzzzzzzzzzzzzz32zzziszzzconv5_3zzz(3,zzz3,zzz512,zzz512)abcdezzzzzzzzzzzzzzzzzzzzzzzz33zzziszzzreluabcdezzzzzzzzzzzzzzzzzzzzzzzz34zzziszzzconv5_4zzz(3,zzz3,zzz512,zzz512)abcdezzzzzzzzzzzzzzzzzzzzzzzz35zzziszzzreluabcdezzzzzzzzzzzzzzzzzzzzzzzz36zzziszzzmaxpoolabcdezzzzzzzzzzzzzzzzzzzzzzzz37zzziszzzfullyconnectedzzz(7,zzz7,zzz512,zzz4096)abcdezzzzzzzzzzzzzzzzzzzzzzzz38zzziszzzreluabcdezzzzzzzzzzzzzzzzzzzzzzzz39zzziszzzfullyconnectedzzz(1,zzz1,zzz4096,zzz4096)abcdezzzzzzzzzzzzzzzzzzzzzzzz40zzziszzzreluabcdezzzzzzzzzzzzzzzzzzzzzzzz41zzziszzzfullyconnectedzzz(1,zzz1,zzz4096,zzz1000)abcdezzzzzzzzzzzzzzzzzzzzzzzz42zzziszzzsoftmaxabcdezzzzzzzzzzzz"""abcdezzzzzzzzzzzzvggzzz=zzzscipy.io.loadmat(path)abcdeabcdezzzzzzzzzzzzvgg_layerszzz=zzzvgg['layers']abcdezzzzzzzzzzzzdefzzz_weights(layer,zzzexpected_layer_name):abcdezzzzzzzzzzzzzzzzzzzzzzzz"""abcdezzzzzzzzzzzzzzzzzzzzzzzzReturnzzzthezzzweightszzzandzzzbiaszzzfromzzzthezzzVGGzzzmodelzzzforzzzazzzgivenzzzlayer.abcdezzzzzzzzzzzzzzzzzzzzzzzz"""abcdezzzzzzzzzzzzzzzzzzzzzzzz#zzzprint(vgg_layers[0][layer][0][0][0])abcdezzzzzzzzzzzzzzzzzzzzzzzzWzzz=zzzvgg_layers[0][layer][0][0][2][0][0]abcdezzzzzzzzzzzzzzzzzzzzzzzzbzzz=zzzvgg_layers[0][layer][0][0][2][0][1]abcdezzzzzzzzzzzzzzzzzzzzzzzzlayer_namezzz=zzzvgg_layers[0][layer][0][0][0]abcdezzzzzzzzzzzzzzzzzzzzzzzz#zzzassertzzzlayer_namezzz==zzzexpected_layer_nameabcdezzzzzzzzzzzzzzzzzzzzzzzzreturnzzzW,zzzbabcdeabcdezzzzzzzzzzzzdefzzz_relu(conv2d_layer):abcdezzzzzzzzzzzzzzzzzzzzzzzz"""abcdezzzzzzzzzzzzzzzzzzzzzzzzReturnzzzthezzzRELUzzzfunctionzzzwrappedzzzoverzzzazzzTensorFlowzzzlayer.zzzExpectszzzaabcdezzzzzzzzzzzzzzzzzzzzzzzzConv2dzzzlayerzzzinput.abcdezzzzzzzzzzzzzzzzzzzzzzzz"""abcdezzzzzzzzzzzzzzzzzzzzzzzzreturnzzztf.nn.relu(conv2d_layer)abcdeabcdezzzzzzzzzzzzdefzzz_conv2d(prev_layer,zzzlayer,zzzlayer_name):abcdezzzzzzzzzzzzzzzzzzzzzzzz"""abcdezzzzzzzzzzzzzzzzzzzzzzzzReturnzzzthezzzConv2Dzzzlayerzzzusingzzzthezzzweights,zzzbiaseszzzfromzzzthezzzVGGabcdezzzzzzzzzzzzzzzzzzzzzzzzmodelzzzatzzz'layer'.abcdezzzzzzzzzzzzzzzzzzzzzzzz"""abcdezzzzzzzzzzzzzzzzzzzzzzzzW,zzzbzzz=zzz_weights(layer,zzzlayer_name)abcdezzzzzzzzzzzzzzzzzzzzzzzzWzzz=zzztf.constant(W)abcdezzzzzzzzzzzzzzzzzzzzzzzzbzzz=zzztf.constant(np.reshape(b,zzz(b.size)))abcdezzzzzzzzzzzzzzzzzzzzzzzzreturnzzztf.nn.conv2d(abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzprev_layer,zzzfilter=W,zzzstrides=[1,zzz1,zzz1,zzz1],zzzpadding='SAME')zzz+zzzbabcdeabcdezzzzzzzzzzzzdefzzz_conv2d_relu(prev_layer,zzzlayer,zzzlayer_name):abcdezzzzzzzzzzzzzzzzzzzzzzzz"""abcdezzzzzzzzzzzzzzzzzzzzzzzzReturnzzzthezzzConv2Dzzz+zzzRELUzzzlayerzzzusingzzzthezzzweights,zzzbiaseszzzfromzzzthezzzVGGabcdezzzzzzzzzzzzzzzzzzzzzzzzmodelzzzatzzz'layer'.abcdezzzzzzzzzzzzzzzzzzzzzzzz"""abcdezzzzzzzzzzzzzzzzzzzzzzzzreturnzzz_relu(_conv2d(prev_layer,zzzlayer,zzzlayer_name))abcdeabcdezzzzzzzzzzzzdefzzz_avgpool(prev_layer):abcdezzzzzzzzzzzzzzzzzzzzzzzz"""abcdezzzzzzzzzzzzzzzzzzzzzzzzReturnzzzthezzzAveragePoolingzzzlayer.abcdezzzzzzzzzzzzzzzzzzzzzzzz"""abcdezzzzzzzzzzzzzzzzzzzzzzzzreturnzzztf.nn.avg_pool(prev_layer,zzzksize=[1,zzz2,zzz2,zzz1],zzzstrides=[1,zzz2,zzz2,zzz1],zzzpadding='SAME')abcdeabcdezzzzzzzzzzzz#zzzConstructszzzthezzzgraphzzzmodel.abcdezzzzzzzzzzzzgraphzzz=zzz{}abcdezzzzzzzzzzzzgraph['input']zzzzzzzzz=zzztf.Variable(np.zeros((1,zzzIMAGE_HEIGHT,zzzIMAGE_WIDTH,zzzCOLOR_CHANNELS)),zzzdtypezzz=zzz'float32')abcdezzzzzzzzzzzzgraph['conv1_1']zzzzzz=zzz_conv2d_relu(graph['input'],zzz0,zzz'conv1_1')abcdezzzzzzzzzzzzgraph['conv1_2']zzzzzz=zzz_conv2d_relu(graph['conv1_1'],zzz2,zzz'conv1_2')abcdezzzzzzzzzzzzgraph['avgpool1']zzz=zzz_avgpool(graph['conv1_2'])abcdezzzzzzzzzzzzgraph['conv2_1']zzzzzz=zzz_conv2d_relu(graph['avgpool1'],zzz5,zzz'conv2_1')abcdezzzzzzzzzzzzgraph['conv2_2']zzzzzz=zzz_conv2d_relu(graph['conv2_1'],zzz7,zzz'conv2_2')abcdezzzzzzzzzzzzgraph['avgpool2']zzz=zzz_avgpool(graph['conv2_2'])abcdezzzzzzzzzzzzgraph['conv3_1']zzzzzz=zzz_conv2d_relu(graph['avgpool2'],zzz10,zzz'conv3_1')abcdezzzzzzzzzzzzgraph['conv3_2']zzzzzz=zzz_conv2d_relu(graph['conv3_1'],zzz12,zzz'conv3_2')abcdezzzzzzzzzzzzgraph['conv3_3']zzzzzz=zzz_conv2d_relu(graph['conv3_2'],zzz14,zzz'conv3_3')abcdezzzzzzzzzzzzgraph['conv3_4']zzzzzz=zzz_conv2d_relu(graph['conv3_3'],zzz16,zzz'conv3_4')abcdezzzzzzzzzzzzgraph['avgpool3']zzz=zzz_avgpool(graph['conv3_4'])abcdezzzzzzzzzzzzgraph['conv4_1']zzzzzz=zzz_conv2d_relu(graph['avgpool3'],zzz19,zzz'conv4_1')abcdezzzzzzzzzzzzgraph['conv4_2']zzzzzz=zzz_conv2d_relu(graph['conv4_1'],zzz21,zzz'conv4_2')abcdezzzzzzzzzzzzgraph['conv4_3']zzzzzz=zzz_conv2d_relu(graph['conv4_2'],zzz23,zzz'conv4_3')abcdezzzzzzzzzzzzgraph['conv4_4']zzzzzz=zzz_conv2d_relu(graph['conv4_3'],zzz25,zzz'conv4_4')abcdezzzzzzzzzzzzgraph['avgpool4']zzz=zzz_avgpool(graph['conv4_4'])abcdezzzzzzzzzzzzgraph['conv5_1']zzzzzz=zzz_conv2d_relu(graph['avgpool4'],zzz28,zzz'conv5_1')abcdezzzzzzzzzzzzgraph['conv5_2']zzzzzz=zzz_conv2d_relu(graph['conv5_1'],zzz30,zzz'conv5_2')abcdezzzzzzzzzzzzgraph['conv5_3']zzzzzz=zzz_conv2d_relu(graph['conv5_2'],zzz32,zzz'conv5_3')abcdezzzzzzzzzzzzgraph['conv5_4']zzzzzz=zzz_conv2d_relu(graph['conv5_3'],zzz34,zzz'conv5_4')abcdezzzzzzzzzzzzgraph['avgpool5']zzz=zzz_avgpool(graph['conv5_4'])abcdezzzzzzzzzzzzreturnzzzgraphabcdeabcde#zzzdefzzzcreateImage(tensor):abcde#zzzzzzzzzzzzzzznewImagezzz=zzznp.zeros((len(tensor[0]),len(tensor[0][0]),3))abcde#zzzzzzzzzzzzzzzforzzzzzzzinzzzrange(len(tensor[0][0][0])):abcde#zzzzzzzzzzzzzzzzzzzzzzzzzzzforzzzyzzzinzzzrange(len(tensor[0])):abcde#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzforzzzxzzzinzzzrange(len(tensor[0][y])):abcde#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzznewImage[y][x][0]zzz=zzztensor[0][y][x][z]abcde#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzznewImage[y][x][1]zzz=zzztensor[0][y][x][z]abcde#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzznewImage[y][x][2]zzz=zzztensor[0][y][x][z]abcde#zzzzzzzzzzzzzzzzzzzzzzzzzzznewImagezzz=zzznp.asarray(newImage).astype('float64')abcde#zzzzzzzzzzzzzzzzzzzzzzzzzzznewImagezzz+=zzzMEAN_VALUES[0]abcde#zzzzzzzzzzzzzzzzzzzzzzzzzzznewImagezzz=zzznewImage[:,zzz:,zzz::-1]abcde#zzzzzzzzzzzzzzzzzzzzzzzzzzznewImagezzz=zzznp.clip(newImage,zzz0,zzz255).astype('uint8')abcde#zzzzzzzzzzzzzzzprint(newImage.shape)abcde#zzzzzzzzzzzzzzzreturnzzznewImageabcdeabcdedefzzzgetNormalizedFx(Fx,x,y):abcdezzzzzzzzzzzzlen1=len(Fx[0][0][0])abcdezzzzzzzzzzzzifzzzxzzz==zzz-1zzzandzzzyzzz==zzz-1:abcdezzzzzzzzzzzzzzzzzzzzzzzzret=[0zzzforzzzizzzin[None]*len1]abcdezzzzzzzzzzzzzzzzzzzzzzzz#zzzforzzzizzzinzzzrange(len1):abcdezzzzzzzzzzzzzzzzzzzzzzzz#zzzzzzzzzzzzzzzret.append(0)abcdezzzzzzzzzzzzzzzzzzzzzzzzreturnzzznp.asarray(ret)abcdeabcdezzzzzzzzzzzz#zzzvectorzzz=zzznp.zeros(len1)abcdezzzzzzzzzzzz#zzzforzzzlayerzzzinzzzrange(len(Fx)):abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzforzzzchannelzzzinzzzrange(len1):abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzvector[channel]zzz=zzzFx[layer][y][x][channel]abcdezzzzzzzzzzzz#zzzvectorzzz=zzznp.zeros(len(Fx[0][0][0]))abcdezzzzzzzzzzzz#zzzforzzzlayerzzzinzzzrange(len(Fx)):abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzforzzzchannelzzzinzzzrange(len(Fx[0][0][0])):abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzvector[channel]zzz=zzzFx[layer][y][x][channel]abcdezzzzzzzzzzzzvectorzzz=zzzFx[0][y][x]abcdezzzzzzzzzzzzreturnzzzvector/np.linalg.norm(vector)abcdeabcdeabcdedefzzzgetPatchPosition(image,zzzimX,zzzimY,zzzpatch):abcdezzzzzzzzzzzzheightzzz=zzzlen(image[0])abcdezzzzzzzzzzzzwidthzzz=zzzlen(image[0][0])abcdezzzzzzzzzzzzpoints=[]abcdezzzzzzzzzzzzlen_mx1zzz=zzz-int(patch[0]/2)abcdezzzzzzzzzzzzlen_px1zzz=zzzint(patch[0]/2)+1abcdezzzzzzzzzzzzlen_mx2zzz=zzz-int(patch[1]/2)abcdezzzzzzzzzzzzlen_px2zzz=zzzint(patch[1]/2)+1abcdezzzzzzzzzzzzforzzzxzzzinzzzrange(len_mx1,zzzlen_px1):abcdezzzzzzzzzzzzzzzzzzzzzzzztempXzzz=zzzimX+xabcdezzzzzzzzzzzzzzzzzzzzzzzzforzzzyzzzinzzzrange(len_mx2,zzzlen_px2):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzifzzz0zzz<=zzztempXzzz<zzzwidthzzzandzzz0<=zzzimY+yzzz<zzzheight:abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzpoints.append([tempX,imY+y])abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzelse:abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzpoints.append([-1,-1])abcdezzzzzzzzzzzzreturnzzzpointsabcdeabcde#指定された位置の半径(randomwalkarea)分の有効な座標を返すabcdedefzzzgetSearchList(image,zzzimX,zzzimY,zzzrandomWalkArea):abcdezzzzzzzzzzzzheightzzz=zzzlen(image[0])abcdezzzzzzzzzzzzwidthzzz=zzzlen(image[0][0])abcdezzzzzzzzzzzzpoints=[]abcdezzzzzzzzzzzzlen_mx1zzz=zzz-int(randomWalkArea[0]/2)abcdezzzzzzzzzzzzlen_px1zzz=zzzint(randomWalkArea[0]/2)+1abcdezzzzzzzzzzzzlen_mx2zzz=zzz-int(randomWalkArea[1]/2)abcdezzzzzzzzzzzzlen_px2zzz=zzzint(randomWalkArea[1]/2)+1abcdezzzzzzzzzzzzforzzzxzzzinzzzrange(len_mx1,len_px1):abcdezzzzzzzzzzzzzzzzzzzzzzzztempXzzz=zzzimX+xabcdezzzzzzzzzzzzzzzzzzzzzzzzforzzzyzzzinzzzrange(len_mx2,len_px2):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzifzzz0zzz<=zzztempXzzz<zzzwidthzzzandzzz0<=zzzimY+yzzz<zzzheight:abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzpoints.append([tempX,imY+y])abcdezzzzzzzzzzzzmap(int,points)abcdezzzzzzzzzzzzreturnzzzpointsabcdeabcdedefzzzgetPhi_L_MtoN(M,N,patch):abcdezzzzzzzzzzzzPhizzz=zzznp.zeros((len(M),len(M[0]),1))abcdezzzzzzzzzzzzforzzzMyzzzinzzzrange(len(M)):abcdezzzzzzzzzzzzzzzzzzzzzzzzforzzzMxzzzinzzzrange(len(M[My])):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzMpositionszzz=zzzgetPatchPosition(M,Mx,My,patch)abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzMFxVector=[]abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzforzzzizzzinzzzrange(len(Mpositions)):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzMFxVector.append(getNormalizedFx(M,zzzMpositions[i][0],zzzMpositions[i][1]))abcdeabcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzminimumzzz=zzz100000abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzminimum_positionszzz=zzz[]abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzforzzzNyzzzinzzzrange(len(N)):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzforzzzNxzzzinzzzrange(len(N[Ny])):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzNpositionszzz=zzzgetPatchPosition(N,Nx,Ny,patch)abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzztotalzzz=zzz0abcdeabcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzforzzzizzzinzzzrange(len(Npositions)):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzNFxzzz=zzzgetNormalizedFx(N,Npositions[i][0],Npositions[i][1])abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzztotalzzz+=zzzabs(MFxVector[i]zzz-zzzNFx)zzz**zzz2abcdeabcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzifzzzminimumzzz>zzztotal:abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzminimumzzz=zzztotalabcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzminimum_positionszzz=zzz[Nx,Ny]abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzPhi[My][Mx]zzz=zzzminimum_positionsabcdezzzzzzzzzzzzreturnzzzPhiabcdeabcde#patchmatchで用いるエネルギー関数を出力するabcdedefzzzgetDistance(Ax,Ay,imgA,imgAdash,Bx,By,imgB,imgBdash,patch):abcdezzzzzzzzzzzzAzzz=zzzgetPatchPosition(imgA,Ax,Ay,patch)abcdezzzzzzzzzzzzBzzz=zzzgetPatchPosition(imgB,Bx,By,patch)abcdezzzzzzzzzzzzsumationAzzz=zzz0abcdezzzzzzzzzzzzsumationBzzz=zzz0abcdeabcdezzzzzzzzzzzzforzzzizzzinzzzrange(len(A)):abcdezzzzzzzzzzzzzzzzzzzzzzzzsumationAzzz+=zzznp.linalg.norm(abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzgetNormalizedFx(imgA,A[i][0],A[i][1])abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz-getNormalizedFx(imgB,B[i][0],B[i][1])abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz)**2abcdezzzzzzzzzzzzzzzzzzzzzzzzsumationBzzz+=zzznp.linalg.norm(abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzgetNormalizedFx(imgAdash,A[i][0],A[i][1])abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz-getNormalizedFx(imgBdash,B[i][0],B[i][1])abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz)**2abcdeabcdezzzzzzzzzzzzreturnzzzsumationA+sumationBabcdeabcde#zzzdefzzzpart_of_patchmatch(imgA,zzzimgAdash,zzzimgB,zzzimgBdash,zzzrandomWalkArea,zzzpatch,zzzx,zzzy,zzzsearchArea):abcde#zzzzzzzzzzzzzzzdiszzzzzz=zzzgetDistance(x,y,imgA,zzzzzzzzzzzzzzzint(searchArea[0]),int(searchArea[1]),zzzimgBzzzzzzzzzzzz,zzzpatch)abcde#zzzzzzzzzzzzzzzdiszzz+=zzzgetDistance(x,y,imgAdash,zzzint(searchArea[0]),int(searchArea[1]),zzzimgBdash,zzzpatch)abcde#zzzzzzzzzzzzzzzsaveXzzz=zzzint(searchArea[0])abcde#zzzzzzzzzzzzzzzsaveYzzz=zzzint(searchArea[1])abcde#zzzzzzzzzzzzzzzreturnzzzdis,saveY,saveXabcdeabcdedefzzzpart_of_patchmatch(imgA,zzzimgAdash,zzzimgB,zzzimgBdash,zzzrandomWalkArea,zzzpatch,zzzPhi,zzzx,zzzy):abcdezzzzzzzzzzzzpositionList=[]abcdezzzzzzzzzzzzifzzzy==0zzzandzzzx==0:abcdezzzzzzzzzzzzzzzzzzzzzzzzprint(np.asarray(Phi).shape)abcdezzzzzzzzzzzzpositionList.append(Phi[y][x])abcdezzzzzzzzzzzzminimumzzz=zzz100000abcdeabcdezzzzzzzzzzzzifzzzy>0zzzandzzzx+1<len(imgA[0]):abcdezzzzzzzzzzzzzzzzzzzzzzzzpositionList.append(Phi[y-1][x+1])abcdezzzzzzzzzzzzifzzzx>0:abcdezzzzzzzzzzzzzzzzzzzzzzzzpositionList.append(Phi[y][x-1])abcdezzzzzzzzzzzzsaveX=0abcdezzzzzzzzzzzzsaveY=0abcdezzzzzzzzzzzzsaveArea=Noneabcdezzzzzzzzzzzzabcdezzzzzzzzzzzz#一番値が近いエリアを探索abcdezzzzzzzzzzzzforzzzposzzzinzzzpositionList:abcdezzzzzzzzzzzzzzzzzzzzzzzz#zzzmap(int,pos)abcdezzzzzzzzzzzzzzzzzzzzzzzz#zzzdiszzzzzz=zzzgetDistance(x,y,imgA,zzzzzzzzzzzzzzzint(pos[0]),int(pos[1]),zzzimgBzzzzzzzzzzzz,zzzpatch)abcdezzzzzzzzzzzzzzzzzzzzzzzz#zzzdiszzz+=zzzgetDistance(x,y,imgAdash,zzzint(pos[0]),int(pos[1]),zzzimgBdash,zzzpatch)abcdezzzzzzzzzzzzzzzzzzzzzzzzdiszzz=zzzgetDistance(x,zzzy,zzzimgA,zzzimgAdash,zzzint(pos[0]),zzzint(pos[1]),zzzimgB,zzzimgBdash,zzzpatch)abcdezzzzzzzzzzzzzzzzzzzzzzzzifzzzminimumzzz>zzzdis:abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzminimumzzz=zzzdisabcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz#zzzprint(x,y,int(searchArea[0]),int(searchArea[1]),dis)abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz#zzzPhi[y][x]zzz=zzzsearchAreazzzabcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzsaveXzzz=zzzint(pos[0])abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzsaveYzzz=zzzint(pos[1])abcdezzzzzzzzzzzz#一番値が近いエリアのみを保存abcdezzzzzzzzzzzzpositionList=[]abcdezzzzzzzzzzzzpositionList=[[saveX,saveY]]abcdezzzzzzzzzzzzminimumzzz=zzz100000abcdezzzzzzzzzzzz#zzzdistancelist=[]abcdeabcdezzzzzzzzzzzzforzzzposzzzinzzzpositionList:abcdezzzzzzzzzzzzzzzzzzzzzzzzmap(int,pos)abcdeabcdezzzzzzzzzzzzzzzzzzzzzzzzsearchListzzz=zzzgetSearchList(imgA,pos[0],pos[1],randomWalkArea)abcdezzzzzzzzzzzzzzzzzzzzzzzz#zzzprint(searchList)abcdezzzzzzzzzzzzzzzzzzzzzzzz#zzzdistancelist.append(Parallel(n_jobs=4)(zzz[delayed(part_of_patchmatch)(imgA,zzzimgAdash,zzzimgB,zzzimgBdash,zzzrandomWalkArea,zzzpatch,zzzx,zzzy,zzzsearchArea)zzzforzzzsearchAreazzzinzzzsearchList]))abcdezzzzzzzzzzzzzzzzzzzzzzzzforzzzsearchAreazzzinzzzsearchList:abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz#zzzmap(int,searchArea)abcdeabcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz#zzzdiszzzzzz=zzzgetDistance(x,y,imgA,zzzzzzzzzzzzzzzint(searchArea[0]),int(searchArea[1]),zzzimgBzzzzzzzzzzzz,zzzpatch)abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz#zzzdiszzz+=zzzgetDistance(x,y,imgAdash,zzzint(searchArea[0]),int(searchArea[1]),zzzimgBdash,zzzpatch)abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzdiszzz=zzzgetDistance(x,zzzy,zzzimgA,zzzimgAdash,zzzint(searchArea[0]),zzzint(searchArea[1]),zzzimgB,zzzimgBdash,zzzpatch)abcdeabcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzifzzzminimumzzz>zzzdis:abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzminimumzzz=zzzdisabcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzsaveXzzz=zzzint(searchArea[0])abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzsaveYzzz=zzzint(searchArea[1])abcdezzzzzzzzzzzzprint(saveY,saveX,y,x)abcdezzzzzzzzzzzzreturnzzzsaveY,saveX,y,xabcdeabcdedefzzzpatchMatch(imgA,zzzimgAdash,zzzimgB,zzzimgBdash,zzzrandomWalkArea,zzzpatch,zzzPhi):abcdezzzzzzzzzzzzprint(patch)abcdezzzzzzzzzzzzindex=[]abcdezzzzzzzzzzzzforzzzyzzzinzzzrange(len(imgA[0])):abcdezzzzzzzzzzzzzzzzzzzzzzzzforzzzxzzzinzzzrange(len(imgA[0][y])):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzindex.append([y,x])abcdeabcdezzzzzzzzzzzzpositions=[]abcdezzzzzzzzzzzzpositions.append(Parallel(n_jobs=7)(zzz[delayed(part_of_patchmatch)(imgA,zzzimgAdash,zzzimgB,zzzimgBdash,zzzrandomWalkArea,zzzpatch,zzzPhi,zzzpos[1],zzzpos[0])zzzforzzzposzzzinzzzindex]))abcdezzzzzzzzzzzzprint("come")abcdezzzzzzzzzzzz#zzzprint(positions)abcdezzzzzzzzzzzzretzzz=zzznp.zeros_like(Phi)abcdezzzzzzzzzzzzpositionszzz=zzznp.asarray(positions)abcdezzzzzzzzzzzz#zzzprint(positions.shape)abcdezzzzzzzzzzzzforzzzposzzzinzzzpositions[0]:abcdezzzzzzzzzzzzzzzzzzzzzzzz#zzzprint(pos[0],pos[1],pos[2],pos[3])abcdezzzzzzzzzzzzzzzzzzzzzzzzret[pos[2]][pos[3]]zzz=zzz[pos[0],pos[1]]abcdezzzzzzzzzzzz#zzzprint(ret)abcdezzzzzzzzzzzz#zzzforzzzyzzzinzzzrange(len(imgA[0])):abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzforzzzxzzzinzzzrange(len(imgA[0][y])):abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzprint(x,y)abcdeabcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzpositionList=[]abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzifzzzy==0zzzandzzzx==0:abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzprint(np.asarray(Phi).shape)abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzpositionList.append(Phi[y][x])abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzminimumzzz=zzz100000abcdeabcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzifzzzy>0zzzandzzzx+1<len(imgA[0]):abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzpositionList.append(Phi[y-1][x+1])abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzifzzzx>0:abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzpositionList.append(Phi[y][x-1])abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzsaveX=0abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzsaveY=0abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzsaveArea=Noneabcdeabcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzz#一番値が近いエリアを探索abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzforzzzposzzzinzzzpositionList:abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzdiszzzzzz=zzzgetDistance(x,y,imgA,zzzzzzzzzzzzzzzint(pos[0]),int(pos[1]),zzzimgBzzzzzzzzzzzz,zzzpatch)abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzdiszzz+=zzzgetDistance(x,y,imgAdash,zzzint(pos[0]),int(pos[1]),zzzimgBdash,zzzpatch)abcdeabcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzifzzzminimumzzz>zzzdis:abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzminimumzzz=zzzdisabcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz#zzzprint(x,y,int(searchArea[0]),int(searchArea[1]),dis)abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz#zzzPhi[y][x]zzz=zzzsearchAreazzzabcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzsaveXzzz=zzzint(pos[0])abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzsaveYzzz=zzzint(pos[1])abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzz#一番値が近いエリアのみを保存abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzpositionList=[[saveX,saveY]]abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzminimumzzz=zzz100000abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzdistancelist=[]abcdeabcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzforzzzposzzzinzzzpositionList:abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzsearchListzzz=zzzgetSearchList(imgA,pos[0],pos[1],randomWalkArea)abcdeabcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz#zzzdistancelist.append(Parallel(n_jobs=4)(zzz[delayed(part_of_patchmatch)(imgA,zzzimgAdash,zzzimgB,zzzimgBdash,zzzrandomWalkArea,zzzpatch,zzzx,zzzy,zzzsearchArea)zzzforzzzsearchAreazzzinzzzsearchList]))abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzforzzzsearchAreazzzinzzzsearchList:abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzdiszzzzzz=zzzgetDistance(x,y,imgA,zzzzzzzzzzzzzzzint(searchArea[0]),int(searchArea[1]),zzzimgBzzzzzzzzzzzz,zzzpatch)abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzdiszzz+=zzzgetDistance(x,y,imgAdash,zzzint(searchArea[0]),int(searchArea[1]),zzzimgBdash,zzzpatch)abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzsaveXzzz=zzzint(searchArea[0])abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzsaveYzzz=zzzint(searchArea[1])abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzdistancelist.append([[dis,saveY,saveX]])abcdeabcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzforzzzdiszzzinzzzdistancelist:abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzifzzzminimumzzz>zzzdis[0][0]:abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzPhi[y][x][0]zzz=zzzdis[0][1]abcdezzzzzzzzzzzz#zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzPhi[y][x][1]zzz=zzzdis[0][2]abcdezzzzzzzzzzzzreturnzzzretabcdeabcdeabcdedefzzzgetPhi_Random(image):abcdezzzzzzzzzzzzprint(len(image))abcdezzzzzzzzzzzzprint(len(image[0]))abcdezzzzzzzzzzzzprint(len(image[0][0]))abcdezzzzzzzzzzzzretzzz=zzz[]abcdezzzzzzzzzzzzforzzzyzzzinzzzrange(len(image[0])):abcdezzzzzzzzzzzzzzzzzzzzzzzzforzzzxzzzinzzzrange(len(image[0][y])):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzret.append([y,x])abcdezzzzzzzzzzzzrandom.shuffle(ret)abcdezzzzzzzzzzzzretzzz=zzznp.asarray(ret)abcdezzzzzzzzzzzzrandomRetzzz=zzznp.reshape(ret,(len(image[0]),len(image[0][0]),2))abcdezzzzzzzzzzzzreturnzzzrandomRetabcdeabcdeabcdedefzzzwarp(image,Phi):abcdezzzzzzzzzzzzretzzz=zzznp.zeros_like(image)abcdezzzzzzzzzzzzforzzzyzzzinzzzrange(len(Phi)):abcdezzzzzzzzzzzzzzzzzzzzzzzzforzzzxzzzinzzzrange(len(Phi[y])):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzznewYzzz=zzzint(Phi[y][x][0])abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzznewXzzz=zzzint(Phi[y][x][1])abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzret[0][newY][newX]zzz=zzzimage[0][y][x]abcdezzzzzzzzzzzzreturnzzzretabcdeabcdedefzzzmakeFinImage(img):abcdezzzzzzzzzzzztempzzz=zzznp.zeros_like(img)abcdezzzzzzzzzzzzforzzzyzzzinzzzrange(len(img)):abcdezzzzzzzzzzzzzzzzzzzzzzzzforzzzxzzzinzzzrange(len(img[0])):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzpositionszzz=zzzgetPatchPosition(img,zzzx,zzzy,zzz[5,5])abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzforzzzzzzzinzzzrange(len(img[0][0])):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzsumationzzz=0abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzforzzzposzzzinzzzpositions:abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzifzzzpos[0]zzz!=zzz-1zzzorzzzpos[1]!=-1:abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzsumationzzz+=zzzimg[y][x][z]abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz#zzzsumationzzz/=zzz25abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzztemp[y][x][z]zzz=zzzsumationabcdezzzzzzzzzzzzreturnzzztempabcdeabcdedefzzzgetWeight(layer,a):abcdezzzzzzzzzzzzk=300abcdezzzzzzzzzzzzt=0.05abcdezzzzzzzzzzzzlayerzzz=zzzlayer/np.linalg.norm(layer)abcdezzzzzzzzzzzzfzzz=zzznp.clip(layer,zzz0,zzz1)abcdezzzzzzzzzzzz#zzzMzzz=zzznp.zeros_like(layer)abcdezzzzzzzzzzzzMzzz=zzznp.zeros_like(layer)abcdezzzzzzzzzzzzforzzzyzzzinzzzrange(len(layer)):abcdezzzzzzzzzzzzzzzzzzzzzzzzforzzzxzzzinzzzrange(len(layer[0])):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzforzzzzzzzinzzzrange(len(layer[0][0])):abcdeabcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzM[y][x][z]=1/(1zzz+zzznp.exp(zzz-k*(f[y][x][z]*f[y][x][z]-t))zzz)abcdezzzzzzzzzzzzreturnzzza*MabcdeabcdedefzzzweightBlend(F,W,R):abcdezzzzzzzzzzzzWzzz=zzznp.clip(np.asarray(W,dtype='float32'),0,1)abcdezzzzzzzzzzzzreturnzzzF*Wzzz+zzzR*(1-W)abcdeabcdeabcdedefzzzbatch_norm_wrapper(inputs,zzzis_training,zzzdecayzzz=zzz0.999):abcdezzzzzzzzzzzzzzzzzzzzzzzzepsilonzzz=zzz1e-5abcdezzzzzzzzzzzzzzzzzzzzzzzzscalezzz=zzztf.Variable(tf.ones([inputs.get_shape()[-1]]))abcdezzzzzzzzzzzzzzzzzzzzzzzzbetazzz=zzztf.Variable(tf.zeros([inputs.get_shape()[-1]]))abcdezzzzzzzzzzzzzzzzzzzzzzzzpop_meanzzz=zzztf.Variable(tf.zeros([inputs.get_shape()[-1]]),zzztrainable=False)abcdezzzzzzzzzzzzzzzzzzzzzzzzpop_varzzz=zzztf.Variable(tf.ones([inputs.get_shape()[-1]]),zzztrainable=False)abcdezzzzzzzzzzzzzzzzzzzzzzzzrankzzz=zzzlen(inputs.get_shape())abcdezzzzzzzzzzzzzzzzzzzzzzzzaxeszzz=zzz[]zzzzzz#zzznn:[0],zzzconv:[0,1,2]abcdezzzzzzzzzzzzzzzzzzzzzzzzforzzzizzzinzzzrange(rankzzz-zzz1):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzaxes.append(i)abcdezzzzzzzzzzzzzzzzzzzzzzzzifzzzis_training:abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzbatch_mean,zzzbatch_varzzz=zzztf.nn.moments(inputs,axes)abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzztrain_meanzzz=zzztf.assign(pop_mean,abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzpop_meanzzz*zzzdecayzzz+zzzbatch_meanzzz*zzz(1zzz-zzzdecay))abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzztrain_varzzz=zzztf.assign(pop_var,abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzpop_varzzz*zzzdecayzzz+zzzbatch_varzzz*zzz(1zzz-zzzdecay))abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzwithzzztf.control_dependencies([train_mean,zzztrain_var]):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzreturnzzztf.nn.batch_normalization(inputs,abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzbatch_mean,zzzbatch_var,zzzbeta,zzzscale,zzzepsilon)abcdezzzzzzzzzzzzzzzzzzzzzzzzelse:abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzreturnzzztf.nn.batch_normalization(inputs,abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzpop_mean,zzzpop_var,zzzbeta,zzzscale,zzzepsilon)abcdedefzzzweight_variable(shape):abcdezzzzzzinitialzzz=zzztf.truncated_normal(shape,zzzstddev=0.1)abcdezzzzzzreturnzzztf.Variable(initial)abcdeabcdedefzzzbias_variable(shape):abcdezzzzzzinitialzzz=zzztf.constant(0.1,zzzshape=shape)abcdezzzzzzreturnzzztf.Variable(initial)abcdeabcdedefzzzconv2d(x,zzzW):abcdezzzzzzreturnzzztf.nn.conv2d(x,zzzW,zzzstrides=[1,zzz1,zzz1,zzz1],zzzpadding='SAME')abcdeabcdedefzzzmax_pool_2x2(x):abcdezzzzzzreturnzzztf.nn.max_pool(x,zzzksize=[1,zzz2,zzz2,zzz1],abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzstrides=[1,zzz2,zzz2,zzz1],zzzpadding='SAME')abcdeabcdedefzzzbuild_model(input_img,IMAGE_WIDTH,IMAGE_HEIGHT,CHANNEL,zzzlayer_num):abcdezzzzzzdefzzzconv_layer(layer_name,zzzlayer_input,zzzW):abcdezzzzzzzzzzzzconvzzz=zzztf.nn.conv2d(layer_input,zzzW,zzzstrides=[1,zzz1,zzz1,zzz1],zzzpadding='SAME')abcdezzzzzzzzzzzzreturnzzzconvabcdeabcdezzzzzzdefzzzrelu_layer(layer_name,zzzlayer_input,zzzb):abcdezzzzzzzzzzzzreluzzz=zzztf.nn.relu(layer_inputzzz+zzzb)abcdezzzzzzzzzzzzreturnzzzreluabcdeabcdezzzzzzdefzzzpool_layer(layer_name,zzzlayer_input):abcdezzzzzzzzzzzzpoolzzz=zzztf.nn.avg_pool(layer_input,zzzksize=[1,zzz2,zzz2,zzz1],zzzabcdezzzzzzzzzzzzzzzzzzstrides=[1,zzz2,zzz2,zzz1],zzzpadding='SAME')abcdezzzzzzzzzzzzzzzzzz#zzzpoolzzz=zzztf.nn.max_pool(layer_input,zzzksize=[1,zzz2,zzz2,zzz1],zzzabcdezzzzzzzzzzzzzzzzzz#zzzzzzzzzstrides=[1,zzz2,zzz2,zzz1],zzzpadding='SAME')abcdezzzzzzzzzzzzreturnzzzpoolabcdeabcdezzzzzzdefzzzget_weights(vgg_layers,zzzi):abcdezzzzzzzzzzzzweightszzz=zzzvgg_layers[i][0][0][2][0][0]abcdezzzzzzzzzzzzWzzz=zzztf.constant(weights)abcdezzzzzzzzzzzzreturnzzzWabcdeabcdezzzzzzdefzzzget_bias(vgg_layers,zzzi):abcdezzzzzzzzzzzzbiaszzz=zzzvgg_layers[i][0][0][2][0][1]abcdezzzzzzzzzzzzbzzz=zzztf.constant(np.reshape(bias,zzz(bias.size)))abcdezzzzzzzzzzzzreturnzzzbabcdeabcdezzzzzznetzzz=zzz{}abcdezzzzzzabcdezzzzzzvgg_rawnetzzzzzzzzzzzzzzz=zzzscipy.io.loadmat(VGG_MODEL)abcdezzzzzzvgg_layerszzzzzzzzzzzzzzz=zzzvgg_rawnet['layers'][0]abcdezzzzzznet['input']zzzzzzzzz=zzztf.Variable(np.asarray([input_img]),zzzdtype=np.float32)abcdezzzzzzzzzzzz#zzznp.zeros((1,IMAGE_WIDTH,IMAGE_HEIGHT,CHANNEL)abcdezzzzzzifzzzlayer_num==1:abcdezzzzzzzzzzzznet['conv1_1']zzz=zzzconv_layer('conv1_1',zzznet['input'],zzzW=get_weights(vgg_layers,zzz0))abcdezzzzzzzzzzzznet['relu1_1']zzz=zzzrelu_layer('relu1_1',zzznet['conv1_1'],zzzb=get_bias(vgg_layers,zzz0))abcdeabcdezzzzzzzzzzzznet['conv1_2']zzz=zzzconv_layer('conv1_2',zzznet['relu1_1'],zzzW=get_weights(vgg_layers,zzz2))abcdezzzzzzzzzzzznet['relu1_2']zzz=zzzrelu_layer('relu1_2',zzznet['conv1_2'],zzzb=get_bias(vgg_layers,zzz2))abcdezzzzzzzzzzzzabcdezzzzzzzzzzzznet['pool1']zzzzzzzzz=zzzpool_layer('pool1',zzznet['relu1_2'])abcdeabcdezzzzzzzzzzzz#zzzifzzzargs.verbose:zzzprint('LAYERzzzGROUPzzz2')zzzzzzabcdezzzzzzzzzzzznet['conv2_1']zzz=zzzconv_layer('conv2_1',zzznet['pool1'],zzzW=get_weights(vgg_layers,zzz5))abcdezzzzzzzzzzzznet['relu2_1']zzz=zzzrelu_layer('relu2_1',zzznet['conv2_1'],zzzb=get_bias(vgg_layers,zzz5))abcdeabcdezzzzzzifzzzlayer_numzzz==zzz2:zzzzzzabcdezzzzzzzzzzzznet['conv2_1']zzz=zzzconv_layer('conv2_1',zzznet['input'],zzzW=get_weights(vgg_layers,zzz5))abcdezzzzzzzzzzzznet['relu2_1']zzz=zzzrelu_layer('relu2_1',zzznet['conv2_1'],zzzb=get_bias(vgg_layers,zzz5))abcdezzzzzzzzzzzznet['conv2_2']zzz=zzzconv_layer('conv2_2',zzznet['relu2_1'],zzzW=get_weights(vgg_layers,zzz7))abcdezzzzzzzzzzzznet['relu2_2']zzz=zzzrelu_layer('relu2_2',zzznet['conv2_2'],zzzb=get_bias(vgg_layers,zzz7))abcdezzzzzzzzzzzzabcdezzzzzzzzzzzznet['pool2']zzzzzzzzz=zzzpool_layer('pool2',zzznet['relu2_2'])abcdezzzzzzzzzzzznet['conv3_1']zzz=zzzconv_layer('conv3_1',zzznet['pool2'],zzzW=get_weights(vgg_layers,zzz10))abcdezzzzzzzzzzzznet['relu3_1']zzz=zzzrelu_layer('relu3_1',zzznet['conv3_1'],zzzb=get_bias(vgg_layers,zzz10))abcdeabcdezzzzzzifzzzlayer_numzzz==zzz3:abcdezzzzzzzzzzzznet['conv3_1']zzz=zzzconv_layer('conv3_1',zzznet['input'],zzzW=get_weights(vgg_layers,zzz10))abcdezzzzzzzzzzzznet['relu3_1']zzz=zzzrelu_layer('relu3_1',zzznet['conv3_1'],zzzb=get_bias(vgg_layers,zzz10))abcdeabcdezzzzzzzzzzzznet['conv3_2']zzz=zzzconv_layer('conv3_2',zzznet['relu3_1'],zzzW=get_weights(vgg_layers,zzz12))abcdezzzzzzzzzzzznet['relu3_2']zzz=zzzrelu_layer('relu3_2',zzznet['conv3_2'],zzzb=get_bias(vgg_layers,zzz12))abcdeabcdezzzzzzzzzzzznet['conv3_3']zzz=zzzconv_layer('conv3_3',zzznet['relu3_2'],zzzW=get_weights(vgg_layers,zzz14))abcdezzzzzzzzzzzznet['relu3_3']zzz=zzzrelu_layer('relu3_3',zzznet['conv3_3'],zzzb=get_bias(vgg_layers,zzz14))abcdeabcdezzzzzzzzzzzznet['conv3_4']zzz=zzzconv_layer('conv3_4',zzznet['relu3_3'],zzzW=get_weights(vgg_layers,zzz16))abcdezzzzzzzzzzzznet['relu3_4']zzz=zzzrelu_layer('relu3_4',zzznet['conv3_4'],zzzb=get_bias(vgg_layers,zzz16))abcdeabcdezzzzzzzzzzzznet['pool3']zzzzzzzzz=zzzpool_layer('pool3',zzznet['relu3_4'])abcdeabcdezzzzzzzzzzzz#zzzifzzzargs.verbose:zzzprint('LAYERzzzGROUPzzz4')abcdezzzzzzzzzzzznet['conv4_1']zzz=zzzconv_layer('conv4_1',zzznet['pool3'],zzzW=get_weights(vgg_layers,zzz19))abcdezzzzzzzzzzzznet['relu4_1']zzz=zzzrelu_layer('relu4_1',zzznet['conv4_1'],zzzb=get_bias(vgg_layers,zzz19))abcdeabcdezzzzzzifzzzlayer_numzzz==zzz4:abcdezzzzzzzzzzzznet['conv4_1']zzz=zzzconv_layer('conv4_1',zzznet['input'],zzzW=get_weights(vgg_layers,zzz19))abcdezzzzzzzzzzzznet['relu4_1']zzz=zzzrelu_layer('relu4_1',zzznet['conv4_1'],zzzb=get_bias(vgg_layers,zzz19))abcdeabcdezzzzzzzzzzzznet['conv4_2']zzz=zzzconv_layer('conv4_2',zzznet['relu4_1'],zzzW=get_weights(vgg_layers,zzz21))abcdezzzzzzzzzzzznet['relu4_2']zzz=zzzrelu_layer('relu4_2',zzznet['conv4_2'],zzzb=get_bias(vgg_layers,zzz21))abcdeabcdezzzzzzzzzzzznet['conv4_3']zzz=zzzconv_layer('conv4_3',zzznet['relu4_2'],zzzW=get_weights(vgg_layers,zzz23))abcdezzzzzzzzzzzznet['relu4_3']zzz=zzzrelu_layer('relu4_3',zzznet['conv4_3'],zzzb=get_bias(vgg_layers,zzz23))abcdeabcdezzzzzzzzzzzznet['conv4_4']zzz=zzzconv_layer('conv4_4',zzznet['relu4_3'],zzzW=get_weights(vgg_layers,zzz25))abcdezzzzzzzzzzzznet['relu4_4']zzz=zzzrelu_layer('relu4_4',zzznet['conv4_4'],zzzb=get_bias(vgg_layers,zzz25))abcdeabcdezzzzzzzzzzzznet['pool4']zzzzzzzzz=zzzpool_layer('pool4',zzznet['relu4_4'])abcdeabcdezzzzzzzzzzzz#zzzifzzzargs.verbose:zzzprint('LAYERzzzGROUPzzz5')abcdezzzzzzzzzzzznet['conv5_1']zzz=zzzconv_layer('conv5_1',zzznet['pool4'],zzzW=get_weights(vgg_layers,zzz28))abcdezzzzzzzzzzzznet['relu5_1']zzz=zzzrelu_layer('relu5_1',zzznet['conv5_1'],zzzb=get_bias(vgg_layers,zzz28))abcdeabcdezzzzzzifzzzlayer_numzzz==zzz5:abcdezzzzzzzzzzzznet['conv5_1']zzz=zzzconv_layer('conv5_1',zzznet['input'],zzzW=get_weights(vgg_layers,zzz28))abcdezzzzzzzzzzzznet['relu5_1']zzz=zzzrelu_layer('relu5_1',zzznet['conv5_1'],zzzb=get_bias(vgg_layers,zzz28))abcdeabcdezzzzzzzzzzzznet['conv5_2']zzz=zzzconv_layer('conv5_2',zzznet['relu5_1'],zzzW=get_weights(vgg_layers,zzz30))abcdezzzzzzzzzzzznet['relu5_2']zzz=zzzrelu_layer('relu5_2',zzznet['conv5_2'],zzzb=get_bias(vgg_layers,zzz30))abcdeabcdezzzzzzzzzzzznet['conv5_3']zzz=zzzconv_layer('conv5_3',zzznet['relu5_2'],zzzW=get_weights(vgg_layers,zzz32))abcdezzzzzzzzzzzznet['relu5_3']zzz=zzzrelu_layer('relu5_3',zzznet['conv5_3'],zzzb=get_bias(vgg_layers,zzz32))abcdeabcdezzzzzzzzzzzznet['conv5_4']zzz=zzzconv_layer('conv5_4',zzznet['relu5_3'],zzzW=get_weights(vgg_layers,zzz34))abcdezzzzzzzzzzzznet['relu5_4']zzz=zzzrelu_layer('relu5_4',zzznet['conv5_4'],zzzb=get_bias(vgg_layers,zzz34))abcdeabcdezzzzzzzzzzzznet['pool5']zzzzzzzzz=zzzpool_layer('pool5',zzznet['relu5_4'])abcdeabcdezzzzzzreturnzzznetabcdeabcdeabcdeabcdeabcdedefzzzcreateImage(tensor):abcdezzzzzzzzzzzznewImagezzz=zzznp.zeros((len(tensor[0]),len(tensor[0][0]),3))abcdezzzzzzzzzzzzforzzzzzzzinzzzrange(len(tensor[0][0][0])):abcdezzzzzzzzzzzzzzzzzzzzzzzzforzzzyzzzinzzzrange(len(tensor[0])):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzforzzzxzzzinzzzrange(len(tensor[0][y])):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzznewImage[y][x][0]zzz=zzztensor[0][y][x][z]abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzznewImage[y][x][1]zzz=zzztensor[0][y][x][z]abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzznewImage[y][x][2]zzz=zzztensor[0][y][x][z]abcdezzzzzzzzzzzzzzzzzzzzzzzznewImagezzz=zzznp.asarray(newImage).astype('float64')abcdezzzzzzzzzzzzzzzzzzzzzzzznewImagezzz+=zzz127.0#MEAN_VALUES[0]abcdezzzzzzzzzzzzzzzzzzzzzzzznewImagezzz=zzznewImage[:,zzz:,zzz::-1]abcdezzzzzzzzzzzzzzzzzzzzzzzznewImagezzz=zzznp.clip(newImage,zzz0,zzz255).astype('uint8')abcdezzzzzzzzzzzzprint(newImage.shape)abcdezzzzzzzzzzzzreturnzzznewImageabcdeabcdeabcdedefzzzminimize_with_lbfgs(sess,zzznet,zzzoptimizer,zzzinit_img,zzzgoal_img):abcdezzzzzzinit_opzzz=zzztf.global_variables_initializer()abcdezzzzzzsess.run(init_op)abcdezzzzzzsess.run(net['input'].assign(init_img))abcdezzzzzz#zzzsess.run(net['y_'].assign(goal_img))abcdezzzzzzoptimizer.minimize(sess)abcdeabcdedefzzzminimize_with_adam(sess,zzznet,zzzoptimizer,zzzinit_img,zzzgoal_img,zzzloss,zzzmax_iterations,zzzcheck_layer,zzzoutput_layer,zzzprint_iterations):abcdezzzzzztrain_opzzz=zzzoptimizer.minimize(loss)abcdezzzzzzinit_opzzz=zzztf.global_variables_initializer()abcdezzzzzzsess.run(init_op)abcdeabcdezzzzzziterationszzz=zzz0abcdezzzzzzwhilezzz(iterationszzz<zzzmax_iterations):abcdezzzzzzzzzzzzsess.run(train_op)abcdezzzzzzzzzzzzifzzziterationszzz%zzzprint_iterations==0:abcdezzzzzzzzzzzzzzzzzzcurr_losszzz=zzzloss.eval()abcdezzzzzzzzzzzzzzzzzzprint("Atzzziteratezzz{}\tf=zzzzzz{:.5E}".format(iterations,zzzcurr_loss))abcdezzzzzzzzzzzzzzzzzz#zzzcv2.imwrite("./output/"+str(iterations)+"input.jpg",createImage(sess.run(net[output_layer])))abcdezzzzzzzzzzzzzzzzzz#zzzcv2.imwrite("./output/"+str(iterations)+"relu.jpg",createImage(sess.run(net[check_layer])))abcdeabcdezzzzzzzzzzzziterationszzz+=zzz1abcdeabcdeabcdedefzzzgetLoss(sess,zzzvggModel,zzzlayer,zzzgenerate_image,zzzgoal_image):abcdeabcdezzzzzzzzzzzzsess.run(vggModel['input'].assign(generate_image))abcdeabcdezzzzzzzzzzzzsubzzz=zzztf.subtract(vggModel[layer],vggModel['y_'])abcdezzzzzzzzzzzzabso=zzztf.norm(sub)abcdezzzzzzzzzzzzreturnzzztf.pow(abso,2)abcdeabcdeabcdedefzzzget_optimizer(loss,zzzselect_optimizer,zzzlearning_rate,zzzmax_iterations,zzzprint_iterations):abcdezzzzzzifzzzselect_optimizerzzz==zzz'lbfgs':abcdezzzzzzzzzzzzoptimizerzzz=zzztf.contrib.opt.ScipyOptimizerInterface(abcdezzzzzzzzzzzzzzzzzzloss,zzzmethod='L-BFGS-B',abcdezzzzzzzzzzzzzzzzzzoptions={'maxiter':zzzmax_iterationsabcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz})abcdezzzzzzelifzzzselect_optimizerzzz==zzz'adam':abcdezzzzzzzzzzzzoptimizerzzz=zzztf.train.AdamOptimizer(learning_rate)abcdezzzzzzreturnzzzoptimizerabcdeabcdeabcdeabcdedefzzznewDeconv(sess,zzzgoal_img,zzzselect_optimizer,zzzmax_iterations,zzzcheck_layer,zzzoutput_layer,zzzlayer_num,zzzchannel):abcdezzzzzzzzzzzz#zzzvggModel['y']zzz=zzztf.Variable(tf.constant(goal_img))abcdezzzzzzzzzzzznoisezzz=zzzgenerateNoiseImage(int(len(goal_img[0])*2),int(len(goal_img[0][0])*2),channel)abcdezzzzzzzzzzzznoisezzz=zzznp.asarray(noise,dtype=np.float32)abcdezzzzzzzzzzzznoisezzz-=zzz127.0abcdezzzzzzzzzzzzinit_imgzzz=zzznp.asarray([noise],dtype=np.float32)abcdeabcdezzzzzzzzzzzzgoal_imgzzz-=127.0abcdezzzzzzzzzzzzgoal_imgzzz=zzznp.asarray([goal_img],dtype=np.float32)abcdeabcdeabcdezzzzzzzzzzzz#zzznoisezzz-=zzz127.0#MEAN_VALUES[0]abcdezzzzzzzzzzzzvggModelzzz=zzzbuild_model(noise,int(len(goal_img[0])/2),int(len(goal_img[0][0])/2),channel,layer_num)abcdezzzzzzzzzzzzvggModel['y_']zzz=zzztf.constant(goal_img)abcdeabcdezzzzzzzzzzzzL_total=getLoss(sess,zzzvggModel,zzzcheck_layer,zzzinit_img,zzzgoal_img)abcdezzzzzzzzzzzz#zzzL_totalzzz=zzzsum_total_variation_losses(sess,zzzvggModel,zzzinit_img)abcdezzzzzzzzzzzzoptimizer=get_optimizer(L_total,select_optimizer,zzz1e-1,zzzmax_iterations,1000)abcdezzzzzzzzzzzzifzzzselect_optimizerzzz==zzz'adam':abcdezzzzzzzzzzzzzzzzzzzzzzzz#zzzsess,zzznet,zzzoptimizer,zzzinit_img,zzzgoal_img,zzzloss,zzzmax_iterations,zzzsess,zzznet,zzzoptimizer,zzzinit_img,zzzgoal_img,zzzloss,zzzmax_iterations,zzzcheck_layer,zzzoutput_layer,zzzprint_iterationsabcdezzzzzzzzzzzzzzzzzzzzzzzzminimize_with_adam(sess,zzzvggModel,zzzoptimizer,zzzinit_img,zzzgoal_img,zzzL_total,max_iterations,check_layer,zzzoutput_layer,1000)abcdezzzzzzzzzzzzelifzzzselect_optimizerzzz==zzz'lbfgs':abcdezzzzzzzzzzzzzzzzzzzzzzzzminimize_with_lbfgs(sess,zzzvggModel,zzzoptimizer,zzzinit_img,zzzgoal_img)abcdeabcdezzzzzzzzzzzzreturnzzzsess.run(vggModel[output_layer])abcdezzzzzzzzzzzz#zzzoutput_imgzzz=zzzsess.run(vggModel[check_layer])abcdezzzzzzzzzzzz#zzzin_imgzzz=zzzsess.run(vggModel[output_layer])abcdeabcdezzzzzzzzzzzz#zzzprint(output_img.shape)abcdezzzzzzzzzzzz#zzzoutput_imgzzz=zzzcreateImage(output_img)abcdezzzzzzzzzzzz#zzzprint(output_img.shape)abcdezzzzzzzzzzzz#zzzoutput_imgzzz=zzzcreateImage(output_img)#zzz+zzzMEAN_VALUESabcdezzzzzzzzzzzz#zzzoutput_imgzzz=zzznp.clip(output_img,0,255).astype('uint8')abcdezzzzzzzzzzzz#zzzcv2.imshow("L4",output_img)abcdezzzzzzzzzzzz#zzzcv2.waitKey(0)abcdezzzzzzzzzzzz#zzzcv2.imshow("L3_2",createImage(in_img))abcdezzzzzzzzzzzz#zzzcv2.waitKey(0)abcdezzzzzzzzzzzz#zzzcv2.imshow("input",createImage(sess.run(vggModel['input'])))abcdezzzzzzzzzzzz#zzzcv2.waitKey(0)abcdeabcdedefzzzgenerateNoiseImage(height,zzzwidth,zzzchannel):abcdezzzzzzzzzzzzrandomByteArrayzzz=zzzbytearray(os.urandom(height*width*channel))zzz#画素数文の乱数発生abcdezzzzzzzzzzzzreturnzzznp.asarray(randomByteArray).reshape((height,zzzwidth,zzzchannel))abcdeabcdedefzzzgetMono(img):abcdezzzzzzzzzzzzreturnzzzcv2.cvtColor(img,zzzcv2.COLOR_RGB2GRAY)abcdeabcdeabcdedefzzzupsampling(Phi):abcdezzzzzzzzzzzztempzzz=zzznp.zeros((len(Phi),len(Phi[0]),3))abcdeabcdezzzzzzzzzzzzforzzzyzzzinzzzrange(len(Phi)):abcdezzzzzzzzzzzzzzzzzzzzzzzzforzzzxzzzinzzzrange(len(Phi[y])):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzztemp[y][x]zzz=zzz[Phi[y][x][0]*2,Phi[y][x][1]*2,0]abcdeabcdezzzzzzzzzzzztempzzz=zzzcv2.resize(temp,zzzNone,zzzfx=2,zzzfy=2,zzzinterpolation=zzzcv2.INTER_NEAREST)abcdeabcdezzzzzzzzzzzzretzzz=zzznp.zeros((len(temp),len(temp[0]),2))abcdezzzzzzzzzzzzforzzzyzzzinzzzrange(len(temp)):abcdezzzzzzzzzzzzzzzzzzzzzzzzforzzzxzzzinzzzrange(len(temp[y])):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzret[y][x]zzz=zzz[temp[y][x][0],temp[y][x][1]]abcdezzzzzzzzzzzzreturnzzznp.asarray(ret)abcdeabcdeabcdedefzzzPhi2Image(Phi):abcdezzzzzzzzzzzzretzzz=zzznp.zeros((len(Phi),len(Phi[0]),3))abcdezzzzzzzzzzzzforzzzyzzzinzzzrange(len(Phi)):abcdezzzzzzzzzzzzzzzzzzzzzzzzforzzzxzzzinzzzrange(len(Phi[y])):abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzret[y][x]zzz=zzz[Phi[y][x][0],0,Phi[y][x][1]]abcdezzzzzzzzzzzzreturnzzzretabcdeabcdeabcdeabcdeabcdeifzzz__name__zzz==zzz'__main__':abcdeabcdezzzzzzzzzzzzsesszzz=zzztf.InteractiveSession()abcdezzzzzzzzzzzztf.global_variables_initializer().run()abcdezzzzzzzzzzzzmodelzzz=zzzload_vgg_model(VGG_MODEL)abcdeabcdezzzzzzzzzzzzimgAzzz=zzzcv2.imread('avater.jpg')abcdezzzzzzzzzzzzimgzzz=zzznp.asarray([imgA]).astype('float64')abcdezzzzzzzzzzzzimgzzz-=zzzMEAN_VALUESabcdezzzzzzzzzzzzimgzzz=zzzimg[:,zzz:,zzz::-1].astype('float64')abcdeabcdeabcdezzzzzzzzzzzzsess.run(model['input'].assign(np.asarray(img)))abcdezzzzzzzzzzzzA=[]abcdezzzzzzzzzzzzA.append(sess.run(model['conv1_1']))abcdezzzzzzzzzzzzA.append(sess.run(model['conv2_1']))abcdezzzzzzzzzzzzA.append(sess.run(model['conv3_1']))abcdezzzzzzzzzzzzA.append(sess.run(model['conv4_1']))abcdezzzzzzzzzzzzA.append(sess.run(model['conv5_1']))abcdeabcdeabcdezzzzzzzzzzzzimgBzzz=zzzcv2.imread('monariza.jpg')abcdezzzzzzzzzzzzimgzzz=zzznp.asarray([imgB]).astype('float64')abcdezzzzzzzzzzzzimgzzz-=zzzMEAN_VALUESabcdezzzzzzzzzzzzimgzzz=zzzimg[:,zzz:,zzz::-1].astype('float64')abcdeabcdeabcdezzzzzzzzzzzzsess.run(model['input'].assign(np.asarray(img)))abcdezzzzzzzzzzzzB=[]abcdezzzzzzzzzzzzB.append(sess.run(model['conv1_1']))abcdezzzzzzzzzzzzB.append(sess.run(model['conv2_1']))abcdezzzzzzzzzzzzB.append(sess.run(model['conv3_1']))abcdezzzzzzzzzzzzB.append(sess.run(model['conv4_1']))abcdezzzzzzzzzzzzB.append(sess.run(model['conv5_1']))abcdeabcdeabcdezzzzzzzzzzzzazzz=zzz[0.8,zzz0.7,zzz0.6,zzz0.1]abcdezzzzzzzzzzzzchannel=[256,128,64,3]abcdezzzzzzzzzzzzcheck_layers=['relu5_1','relu4_1','relu3_1','relu2_1','relu1_1']abcdezzzzzzzzzzzzpatch=[[5,5],[5,5],[5,5],[3,3],[3,3]]abcdezzzzzzzzzzzzrandomWalkArea=[[4,4],[4,4],[6,6],[6,6],[36,36]]abcdeabcdezzzzzzzzzzzzPhiABzzz=zzzgetPhi_Random(A[5-1])abcdezzzzzzzzzzzzPhiBAzzz=zzzgetPhi_Random(B[5-1])abcdeabcdezzzzzzzzzzzz######abcdezzzzzzzzzzzz#zzzi=0abcdezzzzzzzzzzzz#zzz#zzzcv2.namedWindow("img",zzzcv2.WINDOW_NORMAL)abcdezzzzzzzzzzzz#zzzPhiABzzz=zzzpatchMatch(A[5-1-i],zzzB[5-1-i],zzzA[5-1-i],B[5-1-i],zzzzzzrandomWalkArea[5-1-i],zzzpatch[5-1-i],zzzPhiAB)abcdezzzzzzzzzzzz#zzzPhiABzzz=zzzupsampling(PhiAB)abcdezzzzzzzzzzzz#zzzPhiABzzz=zzzupsampling(PhiAB)abcdezzzzzzzzzzzz#zzzPhiABzzz=zzzupsampling(PhiAB)abcdezzzzzzzzzzzz#zzzPhiABzzz=zzzupsampling(PhiAB)abcdeabcdezzzzzzzzzzzz#zzzpiczzz=zzzPhi2Image(PhiAB)abcdezzzzzzzzzzzz#zzzpiczzz=zzznp.asarray(pic*14,zzzdtype='uint8')abcdezzzzzzzzzzzz#zzzcv2.imshow("img",pic)abcdezzzzzzzzzzzz#zzzcv2.waitKey(0)abcdezzzzzzzzzzzz#zzzcv2.destroyAllWindows()abcdezzzzzzzzzzzz#zzzprint(pic)abcdezzzzzzzzzzzz#######abcdeabcdezzzzzzzzzzzzFBzzzzzzzzzzzz=zzzNoneabcdezzzzzzzzzzzzFAdash=zzzNoneabcdezzzzzzzzzzzzforzzzizzzinzzzrange(5):abcdezzzzzzzzzzzzzzzzzzzzzzzzprint("PhiAB:{0}".format(PhiAB.shape))abcdezzzzzzzzzzzzzzzzzzzzzzzzprint("PhiBA:{0}".format(PhiBA.shape))abcdezzzzzzzzzzzzzzzzzzzzzzzzifzzzi==0:abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzPhiABzzz=zzzpatchMatch(A[5-1-i],zzzB[5-1-i],zzzA[5-1-i],B[5-1-i],zzzzzzrandomWalkArea[5-1-i],zzzpatch[5-1-i],zzzPhiAB)abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzPhiBAzzz=zzzpatchMatch(B[5-1-i],zzzA[5-1-i],zzzB[5-1-i],A[5-1-i],zzzrandomWalkArea[5-1-i],zzzpatch[5-1-i],zzzPhiBA)abcdezzzzzzzzzzzzzzzzzzzzzzzzelse:abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz#zzzPhiABzzz=zzzgetPhi_L_MtoN(A[5-1-i],zzzFB,zzzpatch[5-1-i])abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz#zzzPhiBAzzz=zzzgetPhi_L_MtoN(B[5-1-i],zzzFADash,zzzpatch[5-1-i])abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzPhiABzzz=zzzpatchMatch(A[5-1-i],zzzFB,zzzFAdash,zzzB[5-1-i],zzzrandomWalkArea[5-1-i],zzzpatch[5-1-i],zzzPhiAB)abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzPhiBAzzz=zzzpatchMatch(B[5-1-i],zzzFAdash,zzzFB,zzzA[5-1-i],zzzrandomWalkArea[5-1-i],zzzpatch[5-1-i],zzzPhiBA)abcdeabcdeabcdezzzzzzzzzzzzzzzzzzzzzzzzifzzzi<4:abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzAdashzzz=zzzwarp(A[5-1-i],PhiAB)abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzBdashzzz=zzzwarp(B[5-1-i],PhiBA)abcdeabcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzRAzzzzzzzzzzzz=zzznewDeconv(sess,zzzAdash,zzz'adam',zzz5001,zzzcheck_layers[i],zzzcheck_layers[i+1],zzz5-1-i,channel[i])zzzabcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzRBzzzzzzzzzzzz=zzznewDeconv(sess,zzzBdash,zzz'adam',zzz5001,zzzcheck_layers[i],zzzcheck_layers[i+1],zzz5-1-i,channel[i])zzzabcdeabcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzWAzzzzzzzzzzzz=zzzgetWeight(A[5-2-i],a[i])abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzWBzzzzzzzzzzzz=zzzgetWeight(B[5-2-i],a[i])abcdeabcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzprint("RB:{0}".format(RB.shape))abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzprint("A:{0}".format(A[5-2-i].shape))abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzprint("WA:{0}".format(WA.shape))abcdeabcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzFAdash=zzzweightBlend(A[5-2-i],WA,zzzRB)zzzabcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzFBzzzzzzzzzzzz=zzzweightBlend(B[5-2-i],WB,zzzRA)abcdeabcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzPhiABzzz=zzzupsampling(PhiAB)abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzPhiBAzzz=zzzupsampling(PhiBA)abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzcv2.imwrite(str(i)+"A.jpg",Phi2Image(PhiAB))abcdezzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzcv2.imwrite(str(i)+"B.jpg",Phi2Image(PhiBA))zzzabcdeabcdezzzzzzzzzzzztempAzzz=zzzwarp(np.asarray([imgA]),PhiAB)abcdezzzzzzzzzzzztempBzzz=zzzwarp(np.asarray([imgB]),PhiBA)abcdezzzzzzzzzzzzA=makeFinImage(tempA)abcdezzzzzzzzzzzzB=makeFinImage(tempB)abcdezzzzzzzzzzzzprint(A.shape)abcdezzzzzzzzzzzzprint(B.shape)abcdezzzzzzzzzzzzprint(A)abcdezzzzzzzzzzzzprint(B)abcdezzzzzzzzzzzz#zzznp.divide(temp,25.0)abcdezzzzzzzzzzzz#zzzAzzz+=zzzMEAN_VALUESabcdezzzzzzzzzzzz#zzzBzzz+=zzzMEAN_VALUESabcdezzzzzzzzzzzzcv2.imshow("A",np.asarray(A[0],dtype='uint8'))abcdezzzzzzzzzzzzcv2.waitKey(0)abcdezzzzzzzzzzzzcv2.imshow("B",np.asarray(B[0],dtype='uint8'))abcdezzzzzzzzzzzzcv2.waitKey(0)abcdeabcdezzzzzzzzzzzzcv2.imwrite("A.jpg",createImage(A))abcdezzzzzzzzzzzzcv2.imwrite("B.jpg",createImage(B))zzzabcdeabcdezzzzzzzzzzzzsess.close()
